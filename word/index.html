<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>éƒ¨ä»¶å¿«åç·´ç¿’ Â· MVP</title>
<style>
:root{ --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa4ad; --panel:#121821; --accent:#30d158; --warn:#ff453a; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,"Noto Sans TC",sans-serif}
.app{max-width:720px;margin:0 auto;padding:16px 16px 96px}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
.h1{font-weight:800;font-size:20px}<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>éƒ¨ä»¶å¿«åç·´ç¿’ Â· MVP</title>
<style>
:root{ --bg:#0b0f14; --fg:#e6e6e6; --muted:#9aa4ad; --panel:#121821; --accent:#30d158; --warn:#ff453a; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,"Noto Sans TC",sans-serif}
.app{max-width:720px;margin:0 auto;padding:16px 16px 96px}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 0;gap:8px}
.h1{font-weight:800;font-size:20px}
.toolbar{display:flex;gap:8px;align-items:center;justify-content:center}
.toolbar.bottom{position:fixed;bottom:0;left:0;width:100%;background:#0b0f14;padding:16px 12px;border-top:2px solid #2a323c;z-index:10}
.btn{background:var(--accent);color:#002b11;border:0;border-radius:14px;padding:12px 16px;font-weight:800;cursor:pointer;white-space:nowrap}
.btn.ghost{background:transparent;border:2px solid var(--fg);color:var(--fg)}
.btn.sm{padding:4px 10px;font-size:12px;border-radius:999px}
.btn.tab-active{background:var(--fg);color:#0b0f14}
#mic.on{border-color:var(--accent);color:var(--accent);animation:blink 1s infinite ease-in-out}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.45}}
.panel{background:var(--panel);border-radius:16px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.35);margin-top:8px}
#prompt{font-size:clamp(64px,16vw,120px);font-weight:900;text-align:center;letter-spacing:2px;margin:8px 0 12px}
.choices{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.choice{background:#fff;color:#0b0f14;border:2px solid #3a424d;border-radius:14px;padding:20px;font-size:28px;cursor:pointer}
.choice.glyph{font-size:96px;font-weight:900}
.choice:focus{outline:3px solid var(--accent)}
.hint{margin-top:12px;background:#f7d774;color:#000;padding:10px 12px;border-radius:8px;font-weight:bold;display:block;min-height:42px}
.mic-icon{display:inline-block;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.25)} }
.stats{margin-top:8px;color:var(--muted);font-size:14px}
hr{border:none;border-top:1px solid #2a323c;margin:12px 0}

/* å¤§æŒ‰éˆ•æ¨¡å¼ï¼ˆé è¨­å•Ÿç”¨ï¼‰ */
body.big .btn{padding:16px 22px;font-size:20px}
body.big .choice{padding:24px;font-size:32px}
body.big .choice.glyph{font-size:110px}

/* ç·´ç¿’ç•«é¢ï¼šçœ‹â†’èªª / è½â†’æ‰¾ */
.mode-see .app{max-width:min(1200px,92vw);padding:24px 24px 120px}
.mode-see #prompt{font-size:clamp(120px,22vw,260px)}
.mode-see .panel.practice-panel{min-height:80vh;display:flex;flex-direction:column;justify-content:center}

.mode-hear #prompt{font-size:clamp(36px,6vw,56px);margin-top:4vh;margin-bottom:2vh;text-align:center}
.mode-hear .choice{padding:18px;font-size:min(6vw,30px)}
.mode-hear .choice.glyph{font-size:clamp(64px,12vw,100px)}
body.big.mode-hear .btn{padding:16px 22px;font-size:20px}
.mode-hear .toolbar.bottom{padding:16px 12px}
.mode-hear #mic{display:none}
.mode-hear .app{max-width:min(1200px,92vw);padding:24px 24px 120px}
.mode-hear .panel.practice-panel{min-height:70vh;display:flex;flex-direction:column;justify-content:center}
/* è½â†’æ‰¾ï¼šä¸€æ’å››å€‹ */
.mode-hear .choices{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;align-items:stretch;justify-items:stretch}
/* è½â†’æ‰¾ï¼šå­—å¡æ¨£å¼ */
.mode-hear .choice{background:#ffffff;border:2px solid #e5e7eb;color:#0b0f14;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.25);padding:16px}
.mode-hear .choice.glyph{font-size:clamp(56px,10vw,96px);font-weight:900}
.mode-hear .choice:hover{outline:2px solid rgba(48,209,88,.5)}

/* ç®¡ç†é é¢ */
#bank-screen h2{margin:4px 0 8px;font-size:18px}
#bank-screen p{margin:4px 0 12px;font-size:14px;color:var(--muted)}
.bank-form-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.bank-form-row label{display:flex;flex-direction:column;font-size:12px;color:var(--muted);min-width:0;flex:1}
.bank-form-row input,
.bank-form-row select{margin-top:4px;border-radius:8px;border:1px solid #2a323c;padding:8px 10px;background:#05070b;color:var(--fg);font-size:14px}
#bank-list table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
#bank-list th,#bank-list td{border-bottom:1px solid #2a323c;padding:6px 4px;text-align:left}
#bank-list th{color:var(--muted);font-weight:600;font-size:12px}
.bank-empty{font-size:14px;color:var(--muted);margin-top:12px}

/* Dï¼šæ•´é«”æŒ‰éµç•¥ç¸®å°ï¼ˆå·²è¦†å¯«ï¼‰ */
body.big.mode-hear .btn{padding:16px 22px;font-size:20px}
.toolbar.bottom .btn{padding:16px 22px;font-size:20px}
</style>
</head>
<body class="big">
<div class="app" role="application" aria-label="éƒ¨ä»¶å¿«åç·´ç¿’">
  <header>
    <div class="h1">éƒ¨ä»¶å¿«åç·´ç¿’ Â· MVPï¼ˆCanvas é è¦½ï¼‰</div>
    <div class="toolbar">
      <button id="nav-practice" class="btn ghost btn.tab-active">ç·´ç¿’</button>
      <button id="nav-bank" class="btn ghost">é¡Œåº«ç®¡ç†</button>
    </div>
  </header>

  <!-- ç·´ç¿’ç•«é¢ -->
  <section id="practice-screen" class="panel practice-panel" aria-live="polite" aria-atomic="true">
    <div id="prompt">â€”</div>
    <div id="choices" class="choices"></div>
    <div id="hint" class="hint"></div>
    <hr>
    <div id="stats" class="stats"></div>
  </section>

  <!-- é¡Œåº«ç®¡ç†ç•«é¢ -->
  <section id="bank-screen" class="panel" style="display:none">
    <h2>é¡Œåº«ç®¡ç†</h2>
    <p>åœ¨é€™è£¡æ–°å¢ï¼ç·¨è¼¯è¦ç·´ç¿’çš„éƒ¨ä»¶å’Œè®€éŸ³ã€‚å„²å­˜å¾Œï¼Œç·´ç¿’ç•«é¢æœƒä½¿ç”¨ä½ è‡ªè¨‚çš„é¡Œåº«ã€‚</p>

    <form id="bank-form" autocomplete="off">
      <div class="bank-form-row">
        <label>
          å­—ï¼éƒ¨ä»¶
          <input id="bank-glyph" required maxlength="2" placeholder="ä¾‹å¦‚ï¼šæ°µ">
        </label>
        <label>
          è®€éŸ³ï¼åç¨±
          <input id="bank-name" required placeholder="ä¾‹å¦‚ï¼šæ°´éƒ¨">
        </label>
        <label>
          åˆ†é¡ group
          <select id="bank-group" required></select>
        </label>
      </div>
      <div class="bank-form-row" style="align-items:flex-end">
        <div style="flex:1;font-size:12px;color:var(--muted)" id="bank-edit-status">
          æ–°å¢æ¨¡å¼ï¼šè¼¸å…¥ä¸Šé¢ä¸‰æ¬„æŒ‰ä¸‹å„²å­˜å³å¯åŠ å…¥é¡Œåº«ã€‚
        </div>
        <button type="submit" class="btn">å„²å­˜åˆ°é¡Œåº«</button>
      </div>
    </form>

    <div id="bank-list"></div>
  </section>

  <div class="toolbar bottom">
    <button id="mode" class="btn">æ¨¡å¼ï¼šçœ‹â†’èªª</button>
    <button id="replay" class="btn ghost" style="display:none">ğŸ”Š å†å”¸ä¸€æ¬¡</button>
    <button id="mic" class="btn ghost">ğŸ™ èªéŸ³ä½œç­”</button>
    <button id="next" class="btn ghost">ä¸‹ä¸€é¡Œ âœ</button>
  </div>
</div>

<script>
// ===== data.js =====
const DEFAULT_RADICALS = [
  { glyph: "æ°µ", name: "æ°´éƒ¨",   group: "water" },
  { glyph: "æ‰Œ", name: "æ‰‹éƒ¨",   group: "hand" },
  { glyph: "è‰¹", name: "è‰éƒ¨",   group: "grass" },
  { glyph: "äº»", name: "äººéƒ¨",   group: "person" },
  { glyph: "å£", name: "å£éƒ¨",   group: "mouth" },
  { glyph: "æœ¨", name: "æœ¨éƒ¨",   group: "wood" },
  { glyph: "å¿„", name: "å¿ƒéƒ¨",   group: "heart" },
  { glyph: "è¾¶", name: "è¾µéƒ¨",   group: "walk" },
  { glyph: "åˆ‚", name: "åˆ€éƒ¨",   group: "knife" },
  { glyph: "ç¬", name: "ç«éƒ¨",   group: "fire" },
  { glyph: "ç³¹", name: "ç³¸éƒ¨",   group: "silk" },
];
window.GROUPS = {
  water: ["å¿„","æ‰Œ","æ°µ","ç¬"],
  hand: ["æ‰Œ","æ°µ","åˆ‚","äº»"],
  grass: ["è‰¹","ç«¹(âº®)","å»¾","å„"],
  person: ["äº»","å…¥","ä¸¿","äºº"],
  mouth: ["å£","å›—","æ—¥","ç”°"],
  wood: ["æœ¨","æœ¬","æœª","å"],
  heart: ["å¿„","æ°µ","å°","ä¸¬"],
  walk: ["è¾¶","å»´","å†–","â»Œ"],
  knife: ["åˆ‚","åˆ€","ä¸¨","ä¸¿"],
  fire: ["ç¬","ç‚¹","ä¸¶","å°"],
  silk: ["ç³¹","çºŸ","å¹º","ç³¸"],
};

// å¯¦éš›ä½¿ç”¨ä¸­çš„é¡Œåº«é™£åˆ—ï¼ˆå¯è¢«ç®¡ç†é ä¿®æ”¹ï¼‰
const BANK = [];
const GROUPS = window.GROUPS;

function loadBank(){
  let stored = null;
  try{
    stored = JSON.parse(localStorage.getItem('radicals_bank') || '[]');
  }catch(e){
    stored = null;
  }
  if(!Array.isArray(stored) || !stored.length){
    stored = DEFAULT_RADICALS;
  }
  BANK.length = 0;
  stored.forEach(x => BANK.push(x));
}

function saveBank(){
  localStorage.setItem('radicals_bank', JSON.stringify(BANK));
}
</script>

<script>
// ===== app.js =====
const $ = (s) => document.querySelector(s);
const btnNext = $("#next");
const btnToggleMode = $("#mode");
const btnMic = $("#mic");
const btnReplay = $("#replay");
const areaPrompt = $("#prompt");
const areaChoices = $("#choices");
const areaHint = $("#hint");
const areaStats = $("#stats");

const screenPractice = $("#practice-screen");
const screenBank = $("#bank-screen");
const navPractice = $("#nav-practice");
const navBank = $("#nav-bank");

const bankForm = $("#bank-form");
const inputGlyph = $("#bank-glyph");
const inputName = $("#bank-name");
const selectGroup = $("#bank-group");
const bankList = $("#bank-list");
const bankEditStatus = $("#bank-edit-status");

const MODE = { SEE_SAY: "see_say", HEAR_PICK: "hear_pick" };
let mode = MODE.SEE_SAY;
let weights = {};
let current = null;
let total = 0, correct = 0;
let SR = null; let rec = null; let voiceEnabled = false;
let editingIndex = null; // é¡Œåº«ç®¡ç†ï¼šç›®å‰ç·¨è¼¯å“ªä¸€ç­†ï¼ˆnull = æ–°å¢ï¼‰

// ---- å°å·¥å…· ----
const rng = (n) => Math.floor(Math.random() * n);
const speak = (text) => { try { const u = new SpeechSynthesisUtterance(text); u.lang = "zh-TW"; speechSynthesis.cancel(); speechSynthesis.speak(u);} catch (_) {} };
// Web Audio SFXï¼ˆé›¶éŸ³æª”ï¼‰
let _actx; function _ensureCtx(){ try{ _actx=_actx||new (window.AudioContext||window.webkitAudioContext)(); }catch(_){ _actx=null; } return _actx; }
function beep(freq=880, dur=0.12, type='sine', gain=0.05){ const c=_ensureCtx(); if(!c) return; const o=c.createOscillator(), g=c.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(c.destination); o.start(); setTimeout(()=>o.stop(), dur*1000); }
function sfxCorrect(){ beep(880,0.1,'sine'); setTimeout(()=>beep(1320,0.1,'sine'), 120); }
function sfxWrong(){ const c=_ensureCtx(); if(!c) return; const o1=c.createOscillator(), o2=c.createOscillator(), g=c.createGain(); o1.type='square'; o2.type='square'; o1.frequency.value=220; o2.frequency.value=160; g.gain.value=0.03; o1.connect(g); o2.connect(g); g.connect(c.destination); o1.start(); o2.start(); setTimeout(()=>{ o1.stop(); o2.stop(); }, 160); }

// è¨˜éŒ„ï¼ˆæœ¬æ©Ÿï¼‰
function saveWeights(){ localStorage.setItem('weights', JSON.stringify(weights)); }
function normalizeWeights(){
  const set = new Set(BANK.map(x=>x.glyph));
  // ç§»é™¤å·²ç¶“ä¸åœ¨é¡Œåº«è£¡çš„æ¬Šé‡
  Object.keys(weights).forEach(g => { if(!set.has(g)) delete weights[g]; });
  // è£œä¸Šæ–°åŠ å…¥çš„å­—
  BANK.forEach(x => { if(!(x.glyph in weights)) weights[x.glyph] = 1; });
  saveWeights();
}
function loadWeights(){
  try{ weights = JSON.parse(localStorage.getItem('weights')||'{}'); }catch{ weights = {}; }
  normalizeWeights();
}

// å‡ºé¡Œ
function pickWeighted(){
  if(!BANK.length) return null;
  const arr=BANK.map(x=>({item:x,w:Math.max(1,Number(weights[x.glyph]||1))}));
  const sum=arr.reduce((s,a)=>s+a.w,0);
  let t=Math.random()*sum;
  for(const a of arr){ if((t-=a.w)<=0) return a.item; }
  return arr[arr.length-1].item;
}
function genChoices(answer){
  const group=GROUPS[answer.group]||[];
  const wrongs=[];
  const pool=[
    ...BANK.filter(x=>x.glyph!==answer.glyph && group.includes(x.glyph)).map(x=>x.glyph),
    ...BANK.filter(x=>x.glyph!==answer.glyph && !group.includes(x.glyph)).map(x=>x.glyph)
  ];
  while(wrongs.length<3 && pool.length){
    const g=pool.splice(rng(pool.length),1)[0];
    if(!wrongs.includes(g)) wrongs.push(g);
  }
  return [answer.glyph, ...wrongs].sort(()=>0.5-Math.random());
}

// æ ¹æ“šæ¨¡å¼åˆ‡æ›ç‰ˆé¢éŸ¿æ‡‰ï¼ˆçœ‹â†’èªªæ”¾å¤§ã€è½â†’æ‰¾ç¸®å°ï¼†éš±è—éº¥å…‹é¢¨ï¼‰
function syncModeUI(){
  const isSee = mode===MODE.SEE_SAY;
  document.body.classList.toggle('mode-see', isSee);
  document.body.classList.toggle('mode-hear', !isSee);
  // é¡Œå‹ï¼šè½â†’æ‰¾æ™‚é¡¯ç¤ºé‡æ’­æŒ‰éˆ•ï¼›çœ‹â†’èªªæ™‚éš±è—
  btnReplay.style.display = isSee ? 'none' : '';
}

// é¡Œå‹ï¼šçœ‹â†’èªªï¼ˆé¡¯ç¤ºéƒ¨ä»¶ï¼Œç­”æ¡ˆæ˜¯å¿µåç¨±ï¼‰
function renderSeeSay(q){
  // ç´”èªéŸ³ä½œç­”ï¼šä¸é¡¯ç¤ºé¸é …ï¼Œéœ€èªéŸ³æ”¯æ´
  if(!SR){
    // ä¸æ”¯æ´èªéŸ³æ™‚è‡ªå‹•åˆ‡åˆ°ã€Œè½â†’æ‰¾ã€
    mode = MODE.HEAR_PICK;
    btnToggleMode.textContent = 'æ¨¡å¼ï¼šè½â†’æ‰¾';
    return renderHearPick(q);
  }
  areaPrompt.textContent = q.glyph;
  areaChoices.innerHTML = '';
  areaHint.innerHTML = '<span class="mic-icon">ğŸ™</span> æ­£åœ¨è½ä½ èªª...è«‹å¿µå‡ºéƒ¨é¦–ï¼ˆä¾‹å¦‚ï¼šæ°´éƒ¨ï¼‰';

  // è‹¥èªéŸ³å•Ÿç”¨ï¼Œé–‹å§‹è¾¨è­˜ï¼›å¦å‰‡æç¤ºé–‹å•Ÿéº¥å…‹é¢¨
  if(voiceEnabled){
    if(!rec){
      rec = new SR();
      rec.lang = 'zh-TW';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      rec.onend = ()=>{ if(voiceEnabled) { try{ rec.start(); }catch(_){} } };
    }
    rec.onresult = (e)=>{
      const said = (e.results[0][0].transcript||'').trim();
      const ok = said.includes(q.name);
      onAnswer(ok, q);
    };
    try{ rec.start(); }catch(_){ }
    btnMic.classList.add('on');
  } else {
    btnMic.classList.remove('on');
  }
}

// é¡Œå‹ï¼šè½â†’æ‰¾ï¼ˆå…ˆå”¸åç¨±ï¼Œå››é¸ä¸€æ‰¾éƒ¨ä»¶ï¼‰
function renderHearPick(q){
  speak(q.name);
  // è½æ‰¾æ¨¡å¼ï¼šä¸é¡¯ç¤ºæ–‡å­—é¡Œç›®ï¼Œåªæ’­æ”¾èªéŸ³ã€‚è‹¥éœ€è¦å¯æŒ‰ã€Œå†å”¸ä¸€æ¬¡ã€ã€‚
  areaPrompt.textContent = '';
  areaChoices.innerHTML = '';
  for(const g of genChoices(q)){
    const b=document.createElement('button');
    b.className='choice glyph';
    b.textContent=g;
    b.onclick=()=>onAnswer(g===q.glyph, q);
    areaChoices.appendChild(b);
  }
}

function nextQuestion(){
  if(!BANK.length){
    areaPrompt.textContent = 'â€”';
    areaChoices.innerHTML = '';
    areaHint.textContent = 'é¡Œåº«ç›®å‰æ˜¯ç©ºçš„ï¼Œè«‹å…ˆåˆ°ã€Œé¡Œåº«ç®¡ç†ã€æ–°å¢è¦ç·´ç¿’çš„éƒ¨ä»¶ã€‚';
    return;
  }
  current = pickWeighted();
  areaHint.textContent = '';
  if(mode===MODE.SEE_SAY) renderSeeSay(current); else renderHearPick(current);
}

function onAnswer(ok, q){
  total += 1; if(ok) correct += 1;
  weights[q.glyph] = Math.max(1, (weights[q.glyph]||1) + (ok?-1:+1));
  saveWeights();
  if(ok) sfxCorrect(); else sfxWrong();
  speak(q.name);
  areaHint.textContent = (ok?'âœ… æ­£ç¢ºï¼':'âŒ å†è©¦è©¦') + 'ã€€' + q.name;
  updateStats();
}

function updateStats(){
  const rate = total? Math.round(100*correct/total):0;
  areaStats.textContent = `æœ¬æ¬¡ï¼š${correct}/${total}ï¼ˆ${rate}%ï¼‰`;
}

// ===== é¡Œåº«ç®¡ç† UI =====
function initGroupSelect(){
  selectGroup.innerHTML = '';
  Object.keys(GROUPS).forEach(key=>{
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = key;
    selectGroup.appendChild(opt);
  });
}

function renderBankList(){
  bankList.innerHTML = '';
  if(!BANK.length){
    const div = document.createElement('div');
    div.className = 'bank-empty';
    div.textContent = 'ç›®å‰é¡Œåº«æ˜¯ç©ºçš„ï¼Œè«‹å…ˆæ–°å¢ä¸€äº›éƒ¨ä»¶ã€‚';
    bankList.appendChild(div);
    return;
  }
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th style="width:60px">å­—</th><th>è®€éŸ³ï¼åç¨±</th><th>group</th><th style="width:120px">æ“ä½œ</th></tr>';
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  BANK.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.glyph}</td><td>${r.name}</td><td>${r.group||''}</td>`;
    const tdActions = document.createElement('td');
    const btnE = document.createElement('button');
    btnE.type = 'button';
    btnE.className = 'btn sm ghost';
    btnE.textContent = 'ç·¨è¼¯';
    btnE.onclick = ()=>{
      editingIndex = idx;
      inputGlyph.value = r.glyph;
      inputName.value = r.name;
      selectGroup.value = r.group || Object.keys(GROUPS)[0];
      bankEditStatus.textContent = `ç·¨è¼¯æ¨¡å¼ï¼šæ­£åœ¨ç·¨è¼¯ç¬¬ ${idx+1} ç­†ï¼Œä¿®æ”¹å¾ŒæŒ‰ã€Œå„²å­˜åˆ°é¡Œåº«ã€ã€‚`;
    };
    const btnD = document.createElement('button');
    btnD.type = 'button';
    btnD.className = 'btn sm ghost';
    btnD.style.marginLeft = '4px';
    btnD.textContent = 'åˆªé™¤';
    btnD.onclick = ()=>{
      if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${r.glyph}ï¼${r.name}ã€å—ï¼Ÿ`)) return;
      BANK.splice(idx,1);
      saveBank();
      normalizeWeights();
      renderBankList();
    };
    tdActions.appendChild(btnE);
    tdActions.appendChild(btnD);
    tr.appendChild(tdActions);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  bankList.appendChild(table);
}

bankForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  const glyph = inputGlyph.value.trim();
  const name  = inputName.value.trim();
  const group = selectGroup.value;
  if(!glyph || !name || !group) return;

  const payload = { glyph, name, group };

  if(editingIndex!=null){
    BANK[editingIndex] = payload;
    bankEditStatus.textContent = 'å·²æ›´æ–°é¡Œç›®ã€‚ä½ å¯ä»¥ç¹¼çºŒç·¨è¼¯æˆ–æ–°å¢å…¶ä»–éƒ¨ä»¶ã€‚';
  }else{
    // è‹¥å·²å­˜åœ¨åŒ glyphï¼Œè¦†å¯«
    const idx = BANK.findIndex(x=>x.glyph===glyph);
    if(idx>=0) BANK[idx] = payload;
    else BANK.push(payload);
    bankEditStatus.textContent = 'å·²æ–°å¢åˆ°é¡Œåº«ã€‚';
  }
  saveBank();
  normalizeWeights();
  renderBankList();

  // æ¸…ç©ºè¡¨å–®ï¼Œå›åˆ°æ–°å¢æ¨¡å¼
  editingIndex = null;
  inputGlyph.value = '';
  inputName.value = '';
  selectGroup.value = Object.keys(GROUPS)[0];
  inputGlyph.focus();
});

// ç•«é¢åˆ‡æ›ï¼šç·´ç¿’ / é¡Œåº«ç®¡ç†
function showScreen(which){
  const isPractice = which === 'practice';
  screenPractice.style.display = isPractice ? '' : 'none';
  screenBank.style.display = isPractice ? 'none' : '';
  navPractice.classList.toggle('btn.tab-active', isPractice);
  navBank.classList.toggle('btn.tab-active', !isPractice);
}

navPractice.onclick = ()=>{
  showScreen('practice');
};
navBank.onclick = ()=>{
  showScreen('bank');
};

// é‡æ’­é¡Œç›®æŒ‰éˆ•ï¼ˆåƒ…è½â†’æ‰¾æ™‚é¡¯ç¤ºï¼‰
btnReplay.onclick = ()=>{ if(mode===MODE.HEAR_PICK && current){ speak(current.name); } };

// å–®éµèªéŸ³æ§åˆ¶ï¼ˆmic æŒ‰éˆ•ï¼šé–‹å§‹ä½œç­” â†” é€å‡ºç­”æ¡ˆï¼‰
(function setupMic(){
  SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  btnMic.textContent = 'ğŸ™ é–‹å§‹ä½œç­”';
  if(!SR){ btnMic.title='æ­¤è£ç½®ä¸æ”¯æ´èªéŸ³è¾¨è­˜'; btnMic.disabled=true; }
  btnMic.onclick = ()=>{
    voiceEnabled = !voiceEnabled;
    if(voiceEnabled && SR){
      rec = new SR(); rec.lang='zh-TW'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult = (e)=>{
        const said=(e.results[0][0].transcript||'').trim();
        const ok = current && said.includes(current.name);
        if(current) onAnswer(ok, current);
      };
      rec.onend = ()=>{ if(voiceEnabled) try{ rec.start(); }catch(_){ } };
      try{ rec.start(); }catch(_){}
      btnMic.classList.add('on');
      btnMic.textContent = 'ğŸ™ é€å‡ºç­”æ¡ˆ';
      areaHint.textContent = 'ğŸ™ è«‹å¿µå‡ºéƒ¨é¦–åç¨±ï¼Œä¾‹å¦‚ï¼šæ°´éƒ¨';
    } else {
      try{ rec && rec.stop(); }catch(_){}
      btnMic.classList.remove('on');
      btnMic.textContent = 'ğŸ™ é–‹å§‹ä½œç­”';
      areaHint.textContent = '';
    }
  };
})();

// äº‹ä»¶ç¶å®š
btnNext.onclick = nextQuestion;
btnToggleMode.onclick = ()=>{
  mode = (mode===MODE.SEE_SAY)? MODE.HEAR_PICK : MODE.SEE_SAY;
  btnToggleMode.textContent = (mode===MODE.SEE_SAY? 'æ¨¡å¼ï¼šçœ‹â†’èªª' : 'æ¨¡å¼ï¼šè½â†’æ‰¾');
  syncModeUI();
  nextQuestion();
};

// ===== åˆå§‹åŒ– =====
loadBank();
loadWeights();
initGroupSelect();
renderBankList();
syncModeUI();
updateStats();
nextQuestion();
</script>
</body>
</html>

.toolbar{display:flex;gap:8px;align-items:center;justify-content:center}
.toolbar.bottom{position:fixed;bottom:0;left:0;width:100%;background:#0b0f14;padding:16px 12px;border-top:2px solid #2a323c;z-index:10}
.btn{background:var(--accent);color:#002b11;border:0;border-radius:14px;padding:12px 16px;font-weight:800;cursor:pointer}
.btn.ghost{background:transparent;border:2px solid var(--fg);color:var(--fg)}
#mic.on{border-color:var(--accent);color:var(--accent);animation:blink 1s infinite ease-in-out}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.45}}
.panel{background:var(--panel);border-radius:16px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
#prompt{font-size:clamp(64px,16vw,120px);font-weight:900;text-align:center;letter-spacing:2px;margin:8px 0 12px}
.choices{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.choice{background:#fff;color:#0b0f14;border:2px solid #3a424d;border-radius:14px;padding:20px;font-size:28px;cursor:pointer}
.choice.glyph{font-size:96px;font-weight:900}
.choice:focus{outline:3px solid var(--accent)}
.hint{margin-top:12px;background:#f7d774;color:#000;padding:10px 12px;border-radius:8px;font-weight:bold;display:block}
.mic-icon{display:inline-block;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.25)} }
.stats{margin-top:8px;color:var(--muted);font-size:14px}
hr{border:none;border-top:1px solid #2a323c;margin:12px 0}
/* å¤§æŒ‰éˆ•æ¨¡å¼ï¼ˆé è¨­å•Ÿç”¨ï¼‰ */
body.big .btn{padding:16px 22px;font-size:20px}
body.big .choice{padding:24px;font-size:32px}
body.big .choice.glyph{font-size:110px}
.mode-see .app{max-width:min(1200px,92vw);padding:24px 24px 120px}
.mode-see #prompt{font-size:clamp(120px,22vw,260px)}
.mode-see .panel{min-height:80vh;display:flex;flex-direction:column;justify-content:center}

.mode-hear #prompt{font-size:clamp(36px,6vw,56px);margin-top:4vh;margin-bottom:2vh;text-align:center}
.mode-hear .choice{padding:18px;font-size:min(6vw,30px)}
.mode-hear .choice.glyph{font-size:clamp(64px,12vw,100px)}
body.big.mode-hear .btn{padding:16px 22px;font-size:20px}
.mode-hear .toolbar.bottom{padding:16px 12px}
.mode-hear #mic{display:none}
.mode-hear .app{max-width:min(1200px,92vw);padding:24px 24px 120px}
.mode-hear .panel{min-height:70vh;display:flex;flex-direction:column;justify-content:center}
/* Aï¼šä¸€æ’å››å€‹ï¼ˆéŸ¿æ‡‰å¼ä»ä¿æŒå–®æ’ï¼‰ */
.mode-hear .choices{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;align-items:stretch;justify-items:stretch}
/* Bï¼šå­—å¡æ¨£å¼ */
.mode-hear .choice{background:#ffffff;border:2px solid #e5e7eb;color:#0b0f14;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.25);padding:16px}
.mode-hear .choice.glyph{font-size:clamp(56px,10vw,96px);font-weight:900}
.mode-hear .choice:hover{outline:2px solid rgba(48,209,88,.5)}
/* Dï¼šæ•´é«”æŒ‰éµç•¥ç¸®å°ï¼ˆå·²è¦†å¯«ï¼‰ */
body.big.mode-hear .btn{padding:16px 22px;font-size:20px}
.toolbar.bottom .btn{padding:16px 22px;font-size:20px}
</style>
</head>
<body class="big">
<div class="app" role="application" aria-label="éƒ¨ä»¶å¿«åç·´ç¿’">
  <header>
    <div class="h1">éƒ¨ä»¶å¿«åç·´ç¿’ Â· MVPï¼ˆCanvas é è¦½ï¼‰</div>
  </header>

  <section class="panel" aria-live="polite" aria-atomic="true">
    <div id="prompt">â€”</div>
    <div id="choices" class="choices"></div>
    <div id="hint" class="hint"></div>
    <hr>
    <div id="stats" class="stats"></div>
  </section>

  <div class="toolbar bottom">
    <button id="mode" class="btn">æ¨¡å¼ï¼šçœ‹â†’èªª</button>
    <button id="replay" class="btn ghost" style="display:none">ğŸ”Š å†å”¸ä¸€æ¬¡</button>
    <button id="mic" class="btn ghost">ğŸ™ èªéŸ³ä½œç­”</button>
    <button id="next" class="btn ghost">ä¸‹ä¸€é¡Œ âœ</button>
  </div>
</div>

<script>
// ===== data.js =====
window.RADICALS = [
  { glyph: "æ°µ", name: "æ°´éƒ¨",   group: "water" },
  { glyph: "æ‰Œ", name: "æ‰‹éƒ¨",   group: "hand" },
  { glyph: "è‰¹", name: "è‰éƒ¨",   group: "grass" },
  { glyph: "äº»", name: "äººéƒ¨",   group: "person" },
  { glyph: "å£", name: "å£éƒ¨",   group: "mouth" },
  { glyph: "æœ¨", name: "æœ¨éƒ¨",   group: "wood" },
  { glyph: "å¿„", name: "å¿ƒéƒ¨",   group: "heart" },
  { glyph: "è¾¶", name: "è¾µéƒ¨",   group: "walk" },
  { glyph: "åˆ‚", name: "åˆ€éƒ¨",   group: "knife" },
  { glyph: "ç¬", name: "ç«éƒ¨",   group: "fire" },
  { glyph: "ç³¹", name: "ç³¸éƒ¨",   group: "silk" },
];
window.GROUPS = {
  water: ["å¿„","æ‰Œ","æ°µ","ç¬"],
  hand: ["æ‰Œ","æ°µ","åˆ‚","äº»"],
  grass: ["è‰¹","ç«¹(âº®)","å»¾","å„"],
  person: ["äº»","å…¥","ä¸¿","äºº"],
  mouth: ["å£","å›—","æ—¥","ç”°"],
  wood: ["æœ¨","æœ¬","æœª","å"],
  heart: ["å¿„","æ°µ","å°","ä¸¬"],
  walk: ["è¾¶","å»´","å†–","â»Œ"],
  knife: ["åˆ‚","åˆ€","ä¸¨","ä¸¿"],
  fire: ["ç¬","ç‚¹","ä¸¶","å°"],
  silk: ["ç³¹","çºŸ","å¹º","ç³¸"],
};
</script>
<script>
// ===== app.js =====
const $ = (s) => document.querySelector(s);
const btnNext = $("#next");
const btnToggleMode = $("#mode");
const btnMic = $("#mic");
const btnReplay = $("#replay");
const areaPrompt = $("#prompt");
const areaChoices = $("#choices");
const areaHint = $("#hint");
const areaStats = $("#stats");

const MODE = { SEE_SAY: "see_say", HEAR_PICK: "hear_pick" };
let mode = MODE.SEE_SAY;
let weights = {};
let current = null;
let total = 0, correct = 0;
let SR = null; let rec = null; let voiceEnabled = false;

const BANK = window.RADICALS;
const GROUPS = window.GROUPS;

// æ ¹æ“šæ¨¡å¼åˆ‡æ›ç‰ˆé¢éŸ¿æ‡‰ï¼ˆçœ‹â†’èªªæ”¾å¤§ã€è½â†’æ‰¾ç¸®å°ï¼†éš±è—éº¥å…‹é¢¨ï¼‰
function syncModeUI(){
  const isSee = mode===MODE.SEE_SAY;
  document.body.classList.toggle('mode-see', isSee);
  document.body.classList.toggle('mode-hear', !isSee);
  // é¡Œå‹ï¼šè½â†’æ‰¾æ™‚é¡¯ç¤ºé‡æ’­æŒ‰éˆ•ï¼›çœ‹â†’èªªæ™‚éš±è—
  btnReplay.style.display = isSee ? 'none' : '';
}

// ---- å°å·¥å…· ----
const rng = (n) => Math.floor(Math.random() * n);
const speak = (text) => { try { const u = new SpeechSynthesisUtterance(text); u.lang = "zh-TW"; speechSynthesis.cancel(); speechSynthesis.speak(u);} catch (_) {} };
// Web Audio SFXï¼ˆé›¶éŸ³æª”ï¼‰
let _actx; function _ensureCtx(){ try{ _actx=_actx||new (window.AudioContext||window.webkitAudioContext)(); }catch(_){ _actx=null; } return _actx; }
function beep(freq=880, dur=0.12, type='sine', gain=0.05){ const c=_ensureCtx(); if(!c) return; const o=c.createOscillator(), g=c.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(c.destination); o.start(); setTimeout(()=>o.stop(), dur*1000); }
function sfxCorrect(){ beep(880,0.1,'sine'); setTimeout(()=>beep(1320,0.1,'sine'), 120); }
function sfxWrong(){ const c=_ensureCtx(); if(!c) return; const o1=c.createOscillator(), o2=c.createOscillator(), g=c.createGain(); o1.type='square'; o2.type='square'; o1.frequency.value=220; o2.frequency.value=160; g.gain.value=0.03; o1.connect(g); o2.connect(g); g.connect(c.destination); o1.start(); o2.start(); setTimeout(()=>{ o1.stop(); o2.stop(); }, 160); }

// è¨˜éŒ„ï¼ˆæœ¬æ©Ÿï¼‰
function saveWeights(){ localStorage.setItem('weights', JSON.stringify(weights)); }
function loadWeights(){ try{ weights = JSON.parse(localStorage.getItem('weights')||'{}'); }catch{ weights = {}; } BANK.forEach(x=>{ if(!(x.glyph in weights)) weights[x.glyph]=1; }); }
loadWeights();

// å‡ºé¡Œ
function pickWeighted(){ const arr=BANK.map(x=>({item:x,w:Math.max(1,Number(weights[x.glyph]||1))})); const sum=arr.reduce((s,a)=>s+a.w,0); let t=Math.random()*sum; for(const a of arr){ if((t-=a.w)<=0) return a.item; } return arr[arr.length-1].item; }
function genChoices(answer){ const group=GROUPS[answer.group]||[]; const wrongs=[]; const pool=[...BANK.filter(x=>x.glyph!==answer.glyph && group.includes(x.glyph)).map(x=>x.glyph), ...BANK.filter(x=>x.glyph!==answer.glyph && !group.includes(x.glyph)).map(x=>x.glyph)]; while(wrongs.length<3 && pool.length){ const g=pool.splice(rng(pool.length),1)[0]; if(!wrongs.includes(g)) wrongs.push(g);} return [answer.glyph, ...wrongs].sort(()=>0.5-Math.random()); }

// é¡Œå‹ï¼šçœ‹â†’èªªï¼ˆé¡¯ç¤ºéƒ¨ä»¶ï¼Œç­”æ¡ˆé¸åç¨±ï¼‰
function renderSeeSay(q){
  // ç´”èªéŸ³ä½œç­”ï¼šä¸é¡¯ç¤ºé¸é …ï¼Œéœ€èªéŸ³æ”¯æ´
  if(!SR){
    // ä¸æ”¯æ´èªéŸ³æ™‚è‡ªå‹•åˆ‡åˆ°ã€Œè½â†’æ‰¾ã€
    mode = MODE.HEAR_PICK;
    btnToggleMode.textContent = 'æ¨¡å¼ï¼šè½â†’æ‰¾';
    return renderHearPick(q);
  }
  areaPrompt.textContent = q.glyph;
  areaChoices.innerHTML = '';
  areaHint.innerHTML = '<span class="mic-icon">ğŸ™</span> æ­£åœ¨è½ä½ èªª...è«‹å¿µå‡ºéƒ¨é¦–ï¼ˆä¾‹å¦‚ï¼šæ°´éƒ¨ï¼‰';

  // è‹¥èªéŸ³å•Ÿç”¨ï¼Œé–‹å§‹è¾¨è­˜ï¼›å¦å‰‡æç¤ºé–‹å•Ÿéº¥å…‹é¢¨
  if(voiceEnabled){
    if(!rec){
      rec = new SR();
      rec.lang = 'zh-TW';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      rec.onend = ()=>{ if(voiceEnabled) { try{ rec.start(); }catch(_){} } };
    }
    rec.onresult = (e)=>{
      const said = (e.results[0][0].transcript||'').trim();
      const ok = said.includes(q.name);
      onAnswer(ok, q);
    };
    try{ rec.start(); }catch(_){ }
    btnMic.classList.add('on');
  } else {
    btnMic.classList.remove('on');
  }
}


// é¡Œå‹ï¼šè½â†’æ‰¾ï¼ˆå…ˆå”¸åç¨±ï¼Œå››é¸ä¸€æ‰¾éƒ¨ä»¶ï¼‰
function renderHearPick(q){
  speak(q.name);
  // è½æ‰¾æ¨¡å¼ï¼šä¸é¡¯ç¤ºæ–‡å­—é¡Œç›®ï¼Œåªæ’­æ”¾èªéŸ³ã€‚è‹¥éœ€è¦å¯æŒ‰ã€Œå†å”¸ä¸€æ¬¡ã€ã€‚
  areaPrompt.textContent = '';
  areaChoices.innerHTML = '';
  for(const g of genChoices(q)){
    const b=document.createElement('button'); b.className='choice glyph'; b.textContent=g; b.onclick=()=>onAnswer(g===q.glyph, q); areaChoices.appendChild(b);
  }
}

function nextQuestion(){
  current = pickWeighted();
  areaHint.textContent = '';
  if(mode===MODE.SEE_SAY) renderSeeSay(current); else renderHearPick(current);
}

function onAnswer(ok, q){
  total += 1; if(ok) correct += 1;
  weights[q.glyph] = Math.max(1, (weights[q.glyph]||1) + (ok?-1:+1));
  saveWeights();
  if(ok) sfxCorrect(); else sfxWrong();
  speak(q.name);
  areaHint.textContent = (ok?'âœ… æ­£ç¢ºï¼':'âŒ å†è©¦è©¦') + 'ã€€' + q.name;
  updateStats();
}

function updateStats(){ const rate = total? Math.round(100*correct/total):0; areaStats.textContent = `æœ¬æ¬¡ï¼š${correct}/${total}ï¼ˆ${rate}%ï¼‰`; }

// äº‹ä»¶ç¶å®š
btnNext.onclick = nextQuestion;
btnToggleMode.onclick = ()=>{
  mode = (mode===MODE.SEE_SAY)? MODE.HEAR_PICK : MODE.SEE_SAY;
  btnToggleMode.textContent = (mode===MODE.SEE_SAY? 'æ¨¡å¼ï¼šçœ‹â†’èªª' : 'æ¨¡å¼ï¼šè½â†’æ‰¾');
  syncModeUI();
  nextQuestion();
};

// é‡æ’­é¡Œç›®æŒ‰éˆ•ï¼ˆåƒ…è½â†’æ‰¾æ™‚é¡¯ç¤ºï¼‰
btnReplay.onclick = ()=>{ if(mode===MODE.HEAR_PICK && current){ speak(current.name); } };

// å–®éµèªéŸ³æ§åˆ¶ï¼ˆmic æŒ‰éˆ•ï¼šé–‹å§‹ä½œç­” â†” é€å‡ºç­”æ¡ˆï¼‰
(function setupMic(){
  SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  btnMic.textContent = 'ğŸ™ é–‹å§‹ä½œç­”';
  if(!SR){ btnMic.title='æ­¤è£ç½®ä¸æ”¯æ´èªéŸ³è¾¨è­˜'; btnMic.disabled=true; }
  btnMic.onclick = ()=>{
    voiceEnabled = !voiceEnabled;
    if(voiceEnabled && SR){
      rec = new SR(); rec.lang='zh-TW'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult = (e)=>{
        const said=(e.results[0][0].transcript||'').trim();
        const ok = said.includes(current.name);
        onAnswer(ok, current);
      };
      rec.onend = ()=>{ if(voiceEnabled) try{ rec.start(); }catch(_){ } };
      try{ rec.start(); }catch(_){}
      btnMic.classList.add('on');
      btnMic.textContent = 'ğŸ™ é€å‡ºç­”æ¡ˆ';
      areaHint.textContent = 'ğŸ™ è«‹å¿µå‡ºéƒ¨é¦–åç¨±ï¼Œä¾‹å¦‚ï¼šæ°´éƒ¨';
    } else {
      try{ rec && rec.stop(); }catch(_){}
      btnMic.classList.remove('on');
      btnMic.textContent = 'ğŸ™ é–‹å§‹ä½œç­”';
      areaHint.textContent = '';
    }
  };
})();

syncModeUI();
updateStats();
nextQuestion();
</script>
</body>
</html>
