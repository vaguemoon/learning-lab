<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>乘法練習 10×10（觸控版）</title>
  <meta name="description" content="單檔離線乘法練習與測驗，觸控數字鍵盤、0–10 範圍、放大回饋與音效、右側白底 Sidebar 乘法表（可縮放/高亮/切換 9×9）。">
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#06b6d4; --warn:#f59e0b; --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
      --sb-max:640px;
      --sb-width:45vw;
      --cell-font:16px;
      --cell-pad:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, PingFang TC, "Microsoft JhengHei", Helvetica, Arial; background: radial-gradient(1200px 800px at 80% -10%, #1f2937 0%, var(--bg) 60%); color:var(--text); transition: margin .3s ease}
    .container{max-width:1100px; margin:0 auto; padding:24px; transition: margin .3s ease}
    body.with-sidebar .container{ margin-right: min(var(--sb-width), var(--sb-max)); }

    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin:8px 0 16px}
    h1{font-size: clamp(22px, 3vw, 36px); margin:0}
    .badge{font-size:12px; color:#0b1220; background:linear-gradient(120deg, var(--accent), var(--accent2)); padding:6px 10px; border-radius:999px; font-weight:700}

    .grid{display:grid; grid-template-columns: 1.2fr .9fr; gap:20px}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }

    .card{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01)); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card .head{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.06)}
    .card .body{padding:18px}

    .question{display:flex; align-items:center; justify-content:center; gap:18px; font-size: clamp(36px, 7vw, 76px); font-weight:800; letter-spacing:1px; padding:18px 8px}
    .x{opacity:.75}

    .input-wrap{display:flex; gap:12px; justify-content:center; align-items:center; margin-top:8px; flex-wrap:wrap}
    input[type=number]{width:280px; font-size:44px; padding:18px 20px; border-radius:16px; border:1px solid rgba(255,255,255,.15); background:#0b1220; color:var(--text); outline:none}
    input[type=number]:focus{border-color: var(--accent); box-shadow:0 0 0 3px rgba(34,197,94,.25)}
    button{cursor:pointer; border:0; border-radius:14px; padding:16px 18px; font-size:20px; font-weight:800; color:#0b1220; background:linear-gradient(120deg, var(--accent), var(--accent2)); box-shadow:0 6px 18px rgba(0,0,0,.25)}
    button.ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.18); box-shadow:none}
    button.warn{background: linear-gradient(120deg, var(--warn), #ec4899)}
    button.danger{background: linear-gradient(120deg, var(--danger), #ef4444)}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{font-size:16px; padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.12); color:var(--muted)}

    .status{display:flex; gap:16px; flex-wrap:wrap; align-items:center}
    .status .item{display:flex; gap:8px; align-items:center; font-size:16px; color:var(--muted)}
    .dot{width:10px; height:10px; border-radius:999px; background:var(--accent)}

    .hint{margin-top:12px; font-size:16px; color:var(--muted)}

    .feedback{min-height:44px; font-size:34px; font-weight:900; text-align:center; margin-top:14px}
    .ok{color:#34d399}
    .ng{color:#fb7185}
    .pop{animation: pop .55s ease}
    .shake{animation: shake .6s ease}
    @keyframes pop{ 0%{transform:scale(.7); opacity:.4} 60%{transform:scale(1.2); opacity:1} 100%{transform:scale(1)} }
    @keyframes shake{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }

    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; pointer-events:none}
    .overlay.show{display:flex}
    .overlay .msg{font-size: clamp(48px, 10vw, 100px); font-weight:900; padding:18px 26px; border-radius:20px; background:rgba(15,23,42,.65); backdrop-filter: blur(4px)}
    .overlay.ok .msg{color:#86efac; border:2px solid rgba(134,239,172,.6)}
    .overlay.ng .msg{color:#fecaca; border:2px solid rgba(254,202,202,.6)}

    .settings{display:grid; grid-template-columns: repeat(2, 1fr); gap:12px}
    @media (max-width:640px){.settings{grid-template-columns:1fr}}
    label{font-size:15px; color:var(--muted); display:block; margin-bottom:6px}
    select, input[type=range], input[type=checkbox]{width:100%}
    .range{display:flex; gap:8px; align-items:center}

    .table{width:100%; border-collapse:collapse; font-size:16px}
    .table th,.table td{padding:10px 8px; border-bottom:1px dashed rgba(255,255,255,.08); text-align:left}
    .table th{color:var(--muted); font-weight:600}
    .empty{color:var(--muted); text-align:center; padding:10px 0}

    .kbd{display:inline-block; padding:2px 6px; border:1px solid rgba(255,255,255,.25); border-bottom-width:2px; border-radius:6px; font-size:12px; color:var(--muted)}

    .numpad{display:grid; grid-template-columns: repeat(3, minmax(92px,1fr)); gap:12px; max-width: 460px; margin:12px auto 0}
    .numpad button{min-height:80px; font-size:30px; padding:18px 0; border-radius:16px; border:1px solid rgba(255,255,255,.18); background:#0b1220; color:var(--text); box-shadow: var(--shadow)}
    .numpad button:active{transform: translateY(1px)}
    .numpad button.action{font-size:22px; background:linear-gradient(120deg, var(--warn), var(--accent2)); color:#0b1220}

    /* Sidebar 乘法表（白底亮色，可縮放/高亮） */
    #sidebar{position:fixed; top:0; right:0; height:100vh; width:min(var(--sb-width), var(--sb-max)); background:#ffffff; color:#111827; box-shadow: -8px 0 24px rgba(0,0,0,.25); transform: translateX(100%); transition: transform .3s ease; display:flex; flex-direction:column; z-index:50}
    #sidebar.show{transform: translateX(0)}
    #sidebar header{padding:12px 14px; border-bottom:1px solid #e5e7eb; background:#f8fafc; color:#111827; margin:0}
    #sidebar .title{font-size:18px; font-weight:900}
    #sidebar .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    #sidebar .tbtn{background:#111827; color:#fff; border-radius:10px; padding:8px 10px; font-weight:800}
    #sidebar .tbtn.ghost{background:#e5e7eb; color:#111827}
    #sidebar .body{padding:12px; overflow:auto}
    #sidebar .grid{display:grid; grid-template-columns: repeat(12, minmax(52px,1fr)); gap:6px}
    #sidebar .cell{padding:var(--cell-pad); border:1px solid #e5e7eb; border-radius:10px; text-align:center; background:#ffffff; font-weight:800; font-size:var(--cell-font)}
    #sidebar .muted{color:#64748b}
    #sidebar .cell.hl-strong{background:#fef3c7; border-color:#f59e0b}
    #sidebar .cell.hl-soft{background:#e0f2fe; border-color:#38bdf8}

    @media (max-width: 860px){
      :root{ --sb-width: 80vw }
      #sidebar .grid{grid-template-columns: repeat(6, 1fr)}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="row">
        <h1>乘法練習 <span class="badge">離線可用</span></h1>
      </div>
      <div class="row" aria-label="keyboard-hints">
        <span class="pill">送出 <span class="kbd">Enter</span></span>
        <span class="pill">下一題 <span class="kbd">Tab</span></span>
        <span class="pill">清除 <span class="kbd">Esc</span></span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Practice / Quiz Panel -->
      <section class="card" aria-label="quiz-panel">
        <div class="head">
          <div class="row">
            <button id="modePractice" class="ghost" title="練習模式：答對立即換題">練習模式</button>
            <button id="modeQuiz" class="ghost" title="測驗模式：固定題數與倒計時">測驗模式</button>
          </div>
          <div class="status">
            <div class="item"><span class="dot" id="dotMode"></span><span id="modeText">練習模式</span></div>
            <div class="item">進度：<strong id="progress">—</strong></div>
            <div class="item">用時：<strong id="timer">00:00</strong></div>
            <div class="item">連續：<strong id="streak">0</strong></div>
          </div>
        </div>
        <div class="body">
          <div class="question" aria-live="polite">
            <span id="qA">—</span>
            <span class="x">×</span>
            <span id="qB">—</span>
            <span class="x">=</span>
            <span>？</span>
          </div>
          <div class="input-wrap">
            <input id="answer" type="number" inputmode="numeric" placeholder="輸入答案" aria-label="答案" />
            <button id="btnSubmit">送出</button>
            <button id="btnNext" class="ghost" title="跳過或下一題 (Tab)">下一題</button>
          </div>
          <div class="numpad" aria-label="觸控數字鍵盤">
            <button data-key="1">1</button>
            <button data-key="2">2</button>
            <button data-key="3">3</button>
            <button data-key="4">4</button>
            <button data-key="5">5</button>
            <button data-key="6">6</button>
            <button data-key="7">7</button>
            <button data-key="8">8</button>
            <button data-key="9">9</button>
            <button class="action" data-key="back">⌫</button>
            <button data-key="0">0</button>
            <button class="action" data-key="enter">送出</button>
          </div>
          <div id="feedback" class="feedback" aria-live="polite"></div>
          <div class="hint">提示：可限制題庫範圍、切換是否避免重複題；測驗結束會自動保存成績。</div>
        </div>
      </section>

      <!-- Right: Settings & Records -->
      <aside class="card">
        <div class="head">
          <div class="row"><strong>設定</strong></div>
          <div class="row">
            <button id="btnTable" class="ghost" title="在右側顯示乘法表">顯示乘法表</button>
            <button id="btnReset" class="danger" title="清空成績紀錄">清空成績</button>
          </div>
        </div>
        <div class="body">
          <div class="settings">
            <div>
              <label for="rangeA">被乘數範圍（a）</label>
              <div class="range"><span>0</span><input id="rangeA" type="range" min="0" max="10" value="10" /><span>10</span></div>
              <div class="pill">目前：<strong id="showA">0–10</strong></div>
            </div>

            <div>
              <label for="rangeB">乘數範圍（b）</label>
              <div class="range"><span>0</span><input id="rangeB" type="range" min="0" max="10" value="10" /><span>10</span></div>
              <div class="pill">目前：<strong id="showB">0–10</strong></div>
            </div>

            <div>
              <label for="fixedA">只練特定被乘數（a）</label>
              <select id="fixedA">
                <option value="-1">不限（依範圍出題）</option>
                <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option>
                <option value="8">8</option><option value="9">9</option><option value="10">10</option>
              </select>
            </div>

            <div>
              <label for="count">測驗題數</label>
              <select id="count">
                <option value="10">10 題</option>
                <option value="20">20 題</option>
                <option value="30">30 題</option>
              </select>
            </div>

            <div>
              <label for="limitTime">倒數秒數（測驗）</label>
              <select id="limitTime">
                <option value="0">不限時</option>
                <option value="60">60 秒</option>
                <option value="120">120 秒</option>
                <option value="180">180 秒</option>
              </select>
            </div>

            <div>
              <label for="avoidDup">避免重複題</label>
              <input id="avoidDup" type="checkbox" checked />
            </div>

            <div>
              <label for="order">題目順序</label>
              <select id="order">
                <option value="random">隨機</option>
                <option value="ascending">小到大</option>
                <option value="descending">大到小</option>
              </select>
            </div>

            <div>
              <label for="sound">音效</label>
              <input id="sound" type="checkbox" checked />
            </div>
          </div>

          <hr style="border-color: rgba(255,255,255,.08); margin:16px 0" />

          <div>
            <div class="row" style="justify-content:space-between; align-items:center">
              <strong>成績記錄</strong>
              <button id="exportBtn" class="ghost" title="匯出 JSON">匯出</button>
            </div>
            <table class="table" aria-label="records">
              <thead>
                <tr><th>日期時間</th><th>模式</th><th>得分</th><th>時間</th><th>範圍</th></tr>
              </thead>
              <tbody id="recordsBody">
                <tr><td class="empty" colspan="5">尚無記錄</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- BIG OVERLAY -->
  <div id="overlay" class="overlay"><div class="msg">✔ 答對！</div></div>

  <!-- Sidebar（右側白底乘法表） -->
  <aside id="sidebar" aria-label="乘法表側邊欄">
    <header>
      <div class="row" style="justify-content:space-between; width:100%">
        <div class="title">乘法表 <span class="muted" id="tableTitle">（1–12）可捲動</span></div>
        <div class="toolbar">
          <button id="zoomOut" class="tbtn ghost" title="縮小">–</button>
          <button id="zoomIn" class="tbtn" title="放大">＋</button>
          <button id="fitBtn" class="tbtn ghost" title="適合寬度">適合</button>
          <button id="wideBtn" class="tbtn" title="暫時加寬/還原側欄">加寬</button>
          <button id="toggleSize" class="tbtn ghost" title="在 12×12 與 9×9 之間切換">12×12</button>
          <label class="muted" for="highlightSelect">高亮倍數</label>
          <select id="highlightSelect" class="tbtn ghost" style="color:#111827">
            <option value="0">—</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
          </select>
          <button id="clearHL" class="tbtn ghost" title="清除高亮">清除</button>
          <button id="closeSidebar" class="tbtn" title="關閉乘法表">關閉</button>
        </div>
      </div>
    </header>
    <div class="body">
      <div id="tableWrap" class="grid"></div>
    </div>
  </aside>

  <script>
  ;(() => {
    const $ = (s) => document.querySelector(s)
    const $$ = (s) => Array.from(document.querySelectorAll(s))

    const els = {
      qA: $('#qA'), qB: $('#qB'), ans: $('#answer'), submit: $('#btnSubmit'), next: $('#btnNext'),
      modePractice: $('#modePractice'), modeQuiz: $('#modeQuiz'), modeText: $('#modeText'), dotMode: $('#dotMode'),
      progress: $('#progress'), timer: $('#timer'), streak: $('#streak'),
      feedback: $('#feedback'), overlay: $('#overlay'),
      rangeA: $('#rangeA'), rangeB: $('#rangeB'), showA: $('#showA'), showB: $('#showB'),
      fixedA: $('#fixedA'),
      count: $('#count'), limitTime: $('#limitTime'), avoidDup: $('#avoidDup'), order: $('#order'), sound: $('#sound'),
      tableBtn: $('#btnTable'),
      reset: $('#btnReset'), exportBtn: $('#exportBtn'), recordsBody: $('#recordsBody'),
      sidebar: $('#sidebar'), tableWrap: $('#tableWrap'), closeSidebar: $('#closeSidebar'),
      zoomIn: $('#zoomIn'), zoomOut: $('#zoomOut'), fitBtn: $('#fitBtn'), wideBtn: $('#wideBtn'), toggleSize: $('#toggleSize'),
      tableTitle: $('#tableTitle'), highlightSelect: $('#highlightSelect'), clearHL: $('#clearHL')
    }

    const pad = (n) => String(n).padStart(2, '0')
    const nowStr = () => new Date().toLocaleString()

    const state = {
      mode: 'practice',
      aMax: 10, bMax: 10, aMin: 0, bMin: 0,
      fixedA: -1,                 // -1: 不限；0~10: 只出該 a
      count: 10, limit: 0, avoidDup: true, order: 'random', sound: true,
      quiz: { total: 0, done: 0, correct: 0, startAt: 0, timeUsed: 0, timer: null },
      pool: [], used: new Set(), cur: {a: 0, b: 0}, streak: 0,
      tableSize: 12, zoom: 1, highlightN: 0,
      audioCtx: null,
      sidebarWide: false
    }

    /* ===== 乘法表 ===== */
    function renderTable(){
      els.tableWrap.innerHTML = ''
      const n = state.tableSize
      els.tableWrap.style.gridTemplateColumns = `repeat(${n}, minmax(52px,1fr))`
      for(let i = 1; i <= n; i++){
        for(let j = 1; j <= n; j++){
          const cell = document.createElement('div')
          cell.className='cell'
          cell.dataset.i = i; cell.dataset.j = j; cell.dataset.val = (i*j)
          cell.textContent = `${i}×${j}=${i*j}`
          els.tableWrap.appendChild(cell)
        }
      }
      els.toggleSize.textContent = n===12 ? '12×12' : '9×9'
      els.tableTitle.textContent = `（1–${n}）可捲動`
      applyZoom(); applyHighlight(state.highlightN)
    }
    function applyZoom(){
      document.documentElement.style.setProperty('--cell-font', `${16*state.zoom}px`)
      document.documentElement.style.setProperty('--cell-pad', `${10*state.zoom}px`)
    }
    function fitToWidth(){
      const sidebar = els.sidebar.getBoundingClientRect()
      const n = state.tableSize
      const gap = 6 * (n-1)
      const targetCell = Math.max(44, Math.floor((sidebar.width - 24 - gap) / n))
      const newZoom = Math.max(0.6, Math.min(2.2, targetCell / 56))
      state.zoom = newZoom; applyZoom()
    }
    function applyHighlight(n){
      $$('#tableWrap .cell').forEach(cell=> cell.classList.remove('hl-strong','hl-soft'))
      if(!n || n<=0) return
      $$('#tableWrap .cell').forEach(cell=>{
        const i = Number(cell.dataset.i), j = Number(cell.dataset.j), v = Number(cell.dataset.val)
        if(i===n || j===n) cell.classList.add('hl-strong')
        else if(v % n === 0) cell.classList.add('hl-soft')
      })
    }

    /* ===== 題庫與出題 ===== */
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

    function buildPool(){
      const arr = []
      const fixed = state.fixedA

      if (fixed >= 0) {
        // 只練特定被乘數 a=fixed（b 依範圍）
        for(let b = state.bMin; b <= state.bMax; b++) arr.push([fixed, b])
      } else {
        for(let a = state.aMin; a <= state.aMax; a++){
          for(let b = state.bMin; b <= state.bMax; b++) arr.push([a,b])
        }
      }

      if(state.order === 'ascending') arr.sort((x,y)=> (x[0]*x[1]) - (y[0]*y[1]))
      else if(state.order === 'descending') arr.sort((x,y)=> (y[0]*y[1]) - (x[0]*x[1]))
      else shuffle(arr)

      state.pool = arr
      state.used.clear()
    }

    function pick(){
      if(state.pool.length === 0) return [0,0]

      if(state.avoidDup && state.used.size >= state.pool.length) state.used.clear()

      let pair
      if(state.order === 'random'){
        let tries = 0
        do{
          pair = state.pool[Math.floor(Math.random()*state.pool.length)]
          tries++
        } while(state.avoidDup && state.used.has(pair.toString()) && tries < 200)
        if(state.avoidDup) state.used.add(pair.toString())
      }else{
        const idx = (state.avoidDup ? state.used.size : 0) % state.pool.length
        pair = state.pool[idx]
        if(state.avoidDup) state.used.add(pair.toString())
      }
      return pair
    }

    function renderQuestion(){
      const [a,b] = pick(); state.cur={a,b}
      els.qA.textContent = a; els.qB.textContent = b
      els.ans.value=''; els.ans.focus(); els.feedback.textContent=''; els.feedback.className='feedback'
    }

    function startPractice(){
      state.mode='practice'
      els.modeText.textContent='練習模式'
      els.dotMode.style.background = 'var(--accent)'
      els.progress.textContent='—'
      els.timer.textContent='00:00'
      state.streak = 0
      els.streak.textContent='0'
      renderQuestion()
    }

    function startQuiz(){
      state.mode='quiz'
      els.modeText.textContent='測驗模式'
      els.dotMode.style.background = 'var(--warn)'
      state.quiz = { total: state.count, done: 0, correct: 0, startAt: Date.now(), timeUsed: 0, timer: null }
      els.progress.textContent=`0 / ${state.count}`
      tickTimer(true)
      renderQuestion()
    }

    function tickTimer(start=false){
      if(start && state.quiz.timer) clearInterval(state.quiz.timer)
      if(state.mode!=='quiz') return
      const update=()=>{
        const t=Math.floor((Date.now()-state.quiz.startAt)/1000)
        state.quiz.timeUsed=t
        const mm=pad(Math.floor(t/60)), ss=pad(t%60)
        els.timer.textContent=`${mm}:${ss}`
        if(state.limit>0 && t>=state.limit){
          finishQuiz('時間到！')
        }
      }
      update()
      state.quiz.timer=setInterval(update,500)
    }

    function splash(ok){
      const ov = els.overlay
      ov.className = `overlay ${ok?'ok':'ng'} show`
      ov.querySelector('.msg').textContent = ok ? '✔ 答對！' : '✘ 再試試！'
      setTimeout(()=> ov.classList.remove('show'), 650)
    }

    // 音效
    function ensureAudio(){ if(!state.audioCtx) state.audioCtx = new (window.AudioContext||window.webkitAudioContext)() }
    function beep(freq, dur, type='sine', gain=0.08, when=0){
      const ctx=state.audioCtx
      const o=ctx.createOscillator()
      const g=ctx.createGain()
      o.type=type; o.frequency.value=freq
      o.connect(g); g.connect(ctx.destination)
      const t = ctx.currentTime + when
      g.gain.setValueAtTime(0, t)
      g.gain.linearRampToValueAtTime(gain, t+0.01)
      g.gain.exponentialRampToValueAtTime(0.0001, t+dur)
      o.start(t); o.stop(t+dur)
    }
    function playSound(kind){
      if(!state.sound) return
      ensureAudio()
      if(kind==='ok'){
        beep(660,0.12,'sine',0.08,0)
        beep(880,0.12,'sine',0.08,0.12)
        beep(1320,0.18,'triangle',0.09,0.24)
      } else {
        beep(180,0.3,'sawtooth',0.08,0)
        beep(140,0.25,'sawtooth',0.06,0.1)
      }
    }

    function submit(){
      const val = Number(els.ans.value)
      const {a,b} = state.cur
      const ok = (val === a*b)

      if(ok){
        state.streak++
        els.streak.textContent = String(state.streak)
        els.feedback.textContent = '✔ 答對！'
        els.feedback.className='feedback ok pop'
        splash(true)
        playSound('ok')
      } else {
        state.streak = 0
        els.streak.textContent = '0'
        els.feedback.textContent = `✘ 正確是 ${a*b}`
        els.feedback.className='feedback ng shake'
        splash(false)
        playSound('ng')
      }

      if(state.mode==='practice'){
        setTimeout(renderQuestion, ok? 500 : 800)
      } else {
        state.quiz.done++
        if(ok) state.quiz.correct++
        els.progress.textContent = `${state.quiz.done} / ${state.quiz.total}`
        if(state.quiz.done >= state.quiz.total){
          finishQuiz('測驗完成！')
        } else setTimeout(renderQuestion, ok? 450 : 800)
      }
    }

    function finishQuiz(msg){
      if(state.quiz.timer) clearInterval(state.quiz.timer)
      const score = Math.round(100 * state.quiz.correct / Math.max(1,state.quiz.total))
      els.feedback.textContent = `${msg} 得分 ${score}（${state.quiz.correct}/${state.quiz.total}）`
      els.feedback.className = 'feedback ok'
      saveRecord({
        time: nowStr(),
        mode: '測驗',
        score,
        used: state.quiz.timeUsed,
        range: state.fixedA >= 0
          ? `a=${state.fixedA}；b=${state.bMin}-${state.bMax}`
          : `${state.aMin}-${state.aMax}×${state.bMin}-${state.bMax}`
      })
      renderRecords()
    }

    /* ===== 成績 ===== */
    const LS_KEY = '乘法成績'
    function readRecords(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]') }catch(e){ return [] } }
    function saveRecord(rec){ const list = readRecords(); list.unshift(rec); localStorage.setItem(LS_KEY, JSON.stringify(list)) }
    function renderRecords(){
      const list = readRecords()
      els.recordsBody.innerHTML = ''
      if(list.length===0){
        const tr=document.createElement('tr')
        tr.innerHTML = `<td class="empty" colspan="5">尚無記錄</td>`
        els.recordsBody.appendChild(tr)
        return
      }
      for(const r of list.slice(0,50)){
        const tr=document.createElement('tr')
        const mm=pad(Math.floor(r.used/60)), ss=pad(r.used%60)
        tr.innerHTML = `<td>${r.time}</td><td>${r.mode}</td><td>${r.score}</td><td>${mm}:${ss}</td><td>${r.range}</td>`
        els.recordsBody.appendChild(tr)
      }
    }

    function exportJSON(){
      const blob=new Blob([localStorage.getItem(LS_KEY)||'[]'],{type:'application/json'})
      const url=URL.createObjectURL(blob)
      const a=document.createElement('a')
      a.href=url
      a.download=`乘法成績-${Date.now()}.json`
      a.click()
      URL.revokeObjectURL(url)
    }

    /* ===== Sidebar ===== */
    function openSidebar(){
      document.body.classList.add('with-sidebar')
      els.sidebar.classList.add('show')
      renderTable()
      els.tableBtn.textContent='隱藏乘法表'
    }
    function closeSidebar(){
      document.body.classList.remove('with-sidebar')
      els.sidebar.classList.remove('show')
      els.tableBtn.textContent='顯示乘法表'
    }

    /* ===== 設定同步 ===== */
    function syncRanges(){
      state.aMax = Number(els.rangeA.value)
      state.bMax = Number(els.rangeB.value)
      state.aMin = 0
      state.bMin = 0
      els.showA.textContent = `${state.aMin}–${state.aMax}`
      els.showB.textContent = `${state.bMin}–${state.bMax}`
      buildPool()
    }

    /* ===== 事件綁定 ===== */
    els.modePractice.addEventListener('click', startPractice)
    els.modeQuiz.addEventListener('click', startQuiz)
    els.submit.addEventListener('click', submit)
    els.next.addEventListener('click', renderQuestion)

    els.ans.addEventListener('keydown', (e)=>{
      if(e.key==='Enter') submit()
      else if(e.key==='Escape'){ els.ans.value=''; els.ans.focus() }
      else if(e.key==='Tab'){ e.preventDefault(); renderQuestion() }
    })

    // numpad
    $$('.numpad button').forEach(btn=>{
      const key = btn.dataset.key
      btn.addEventListener('click', ()=>{
        if(key==='back'){
          els.ans.value = String(els.ans.value).slice(0,-1)
        } else if(key==='enter'){
          submit()
        } else {
          els.ans.value = String(els.ans.value || '') + key
        }
        els.ans.focus({preventScroll:true})
      })
    })

    els.rangeA.addEventListener('input', ()=>{
      // 固定 a 時，rangeA 對題目不生效，但仍允許調整以備切回不限
      syncRanges()
      if(state.mode === 'practice') renderQuestion()
    })
    els.rangeB.addEventListener('input', ()=>{
      syncRanges()
      if(state.mode === 'practice') renderQuestion()
    })

    els.fixedA.addEventListener('change', ()=>{
      state.fixedA = Number(els.fixedA.value)
      buildPool()
      if(state.mode === 'practice') renderQuestion()

      // 若乘法表開著，選固定 a 時順便高亮（可選）
      if(els.sidebar.classList.contains('show')){
        if(state.fixedA >= 0){
          els.highlightSelect.value = String(state.fixedA)
          state.highlightN = state.fixedA
          applyHighlight(state.highlightN)
        }
      }
    })

    els.count.addEventListener('change', ()=> state.count = Number(els.count.value))
    els.limitTime.addEventListener('change', ()=> state.limit = Number(els.limitTime.value))
    els.avoidDup.addEventListener('change', ()=> state.avoidDup = els.avoidDup.checked)
    els.order.addEventListener('change', ()=> { state.order = els.order.value; buildPool() })
    els.sound.addEventListener('change', ()=> state.sound = els.sound.checked)

    // Sidebar 按鈕
    els.tableBtn.addEventListener('click', ()=> els.sidebar.classList.contains('show') ? closeSidebar() : openSidebar())
    els.closeSidebar.addEventListener('click', closeSidebar)
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && els.sidebar.classList.contains('show')) closeSidebar() })

    els.zoomIn.addEventListener('click', ()=>{ state.zoom=Math.min(2.4, state.zoom+0.1); applyZoom() })
    els.zoomOut.addEventListener('click', ()=>{ state.zoom=Math.max(0.6, state.zoom-0.1); applyZoom() })
    els.fitBtn.addEventListener('click', fitToWidth)

    // 加寬/還原：用狀態控制，避免小螢幕 media query 造成反向效果
    els.wideBtn.addEventListener('click', ()=>{
      state.sidebarWide = !state.sidebarWide
      document.documentElement.style.setProperty('--sb-width', state.sidebarWide ? '50vw' : '')
      els.wideBtn.textContent = state.sidebarWide ? '還原' : '加寬'
      fitToWidth()
    })

    els.toggleSize.addEventListener('click', ()=>{ state.tableSize = (state.tableSize===12? 9:12); renderTable(); fitToWidth() })
    els.highlightSelect.addEventListener('change', ()=>{ state.highlightN = Number(els.highlightSelect.value)||0; applyHighlight(state.highlightN) })
    els.clearHL.addEventListener('click', ()=>{ els.highlightSelect.value='0'; state.highlightN=0; applyHighlight(0) })

    // 成績控制
    els.reset.addEventListener('click', ()=>{ if(confirm('確定要清空所有成績記錄？')){ localStorage.removeItem(LS_KEY); renderRecords() } })
    els.exportBtn.addEventListener('click', exportJSON)

    // 初始化（先同步範圍→建題庫→再開始）
    syncRanges()
    renderRecords()
    startPractice()
  })()
  </script>
</body>
</html>
